#!/usr/bin/python
import os,sys,string

dn = os.path.dirname(os.path.realpath(__file__))
dn=dn[:dn.rfind(os.sep)]

#Backup user data if started in current folder

#Define data and backup folders: backup only if
#current folder is in data path
#__Default_Data_Folder must be a GLOBAL variable!
print "\n"*3
print "WARNING: This backup should be executed only at the END of your experiment! (or not repeated often!)"
print "\n"*3
try:
    __Default_Data_Folder = os.getenv("SPECK_DATA_FOLDER")
    __Default_Backup_Folder = os.getenv("SPECK_BACKUP_FOLDER")
    if __Default_Backup_Folder == "":
        print "NO BACKUP: no backup folder defined."
        raise Exception("GoodBye")
    currentDataFolder=os.path.realpath(os.getcwd())
    print "Data Folder is :",currentDataFolder
    if currentDataFolder.startswith(__Default_Data_Folder) and len(currentDataFolder.split(os.sep)) > len(__Default_Data_Folder.split(os.sep)):
        currentBackupFolder=__Default_Backup_Folder+"/"+\
        currentDataFolder.lstrip(__Default_Data_Folder.rstrip("/"))
        cbf=currentBackupFolder
        currentBackupFolder=cbf[:cbf.rstrip("/").rfind("/")]
    else:
        print "No backup!"
        raise Exception("No backup out of predefined data folders")
    print "Backup Folder is :",currentBackupFolder
except (KeyboardInterrupt,SystemExit), tmp:
    print "Backup halted on user request"
    raise tmp
try:
    #command="rsync --ignore-existing -auv --temp-dir=/tmp '"+currentDataFolder+"' '"+currentBackupFolder+"'"
    command="rsync -auv --temp-dir=/tmp '"+currentDataFolder+"' '"+currentBackupFolder+"'"
    os.system(command)
except (KeyboardInterrupt,SystemExit), tmp:
    print "Backup halted on user request"
    raise tmp
    
